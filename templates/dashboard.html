{% extends "base.html" %}
{% block content %}
<!-- KPI cards -->
<div class="grid md:grid-cols-4 gap-6">
  <div class="card kpi">
    <div class="text-slate-500 text-sm">VPN</div>
    <div class="text-3xl font-semibold" id="count-vpn">0</div>
  </div>
  <div class="card kpi">
    <div class="text-slate-500 text-sm">Honeyfield</div>
    <div class="text-3xl font-semibold" id="count-honeyfield">0</div>
  </div>
  <div class="card kpi">
    <div class="text-slate-500 text-sm">Honeypot</div>
    <div class="text-3xl font-semibold" id="count-honeypot">0</div>
  </div>
  <div class="card kpi">
    <div class="text-slate-500 text-sm">Behavior</div>
    <div class="text-3xl font-semibold" id="count-behavior">0</div>
    <div class="mt-1 text-xs text-slate-500">Erratic: <span id="count-behavior-err">0</span></div>
  </div>
</div>

<!-- 7-day chart -->
<div class="card mt-6">
  <h3 class="text-lg font-semibold mb-3">Events (last 7 days)</h3>
  <div class="chart-wrap"><canvas id="dailyChart"></canvas></div>
</div>

<!-- Logs: Behavior + Selectable (VPN/Honeypot/Honeyfield) -->
<div class="mt-6 grid md:grid-cols-2 gap-6">
  <!-- Behavior logs -->
  <div class="card">
    <h3 class="text-lg font-semibold mb-3">Recent Behavior</h3>
    <div class="overflow-auto max-h-[320px]">
      <table class="min-w-full text-sm">
        <thead class="sticky top-0 bg-slate-100">
          <tr>
            <th class="p-2 text-left">Time</th>
            <th class="p-2 text-left">Severity</th>
            <th class="p-2 text-left">Tags</th>
            <th class="p-2 text-left">IP</th>
          </tr>
        </thead>
        <tbody id="behaviorBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Selectable logs -->
  <div class="card">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-semibold">Recent Logs</h3>
      <select id="logKind" class="border rounded px-2 py-1">
        <option value="vpn">VPN</option>
        <option value="honeypot">Honeypot</option>
        <option value="honeyfield">Honeyfield</option>
      </select>
    </div>
    <div class="overflow-auto max-h-[320px]">
      <table class="min-w-full text-sm">
        <thead class="sticky top-0 bg-slate-100">
          <tr>
            <th class="p-2 text-left">Time</th>
            <th class="p-2 text-left">Severity</th>
            <th class="p-2 text-left">IP</th>
            <th class="p-2 text-left">Details</th>
          </tr>
        </thead>
        <tbody id="selectableBody"></tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function loadMetrics(){
  const r = await fetch('/api/metrics', {cache:'no-store'});
  const data = await r.json();

  // KPI counts
  document.getElementById('count-vpn').textContent = data.counts.vpn || 0;
  document.getElementById('count-honeyfield').textContent = data.counts.honeyfield || 0;
  document.getElementById('count-honeypot').textContent = data.counts.honeypot || 0;
  document.getElementById('count-behavior').textContent = data.counts.behavior || 0;
  document.getElementById('count-behavior-err').textContent = data.counts.behavior_erratic || 0;

  // Chart data
  let labels = Object.keys(data.daily || {}).sort();
  if (labels.length === 0) {
    const today = new Date();
    for (let i = 6; i >= 0; i--) {
      const d = new Date(today.getFullYear(), today.getMonth(), today.getDate() - i).toISOString().slice(0,10);
      data.daily = data.daily || {};
      data.daily[d] = {vpn:0,honeyfield:0,honeypot:0,behavior:0};
    }
    labels = Object.keys(data.daily).sort();
  }
  const vpn       = labels.map(d => data.daily[d].vpn || 0);
  const honeyfield= labels.map(d => data.daily[d].honeyfield || 0);
  const honeypot  = labels.map(d => data.daily[d].honeypot || 0);
  const behavior  = labels.map(d => data.daily[d].behavior || 0);

  // Chart render/reset
  const ctx = document.getElementById('dailyChart').getContext('2d');
  if (window.__dailyChart) { window.__dailyChart.destroy(); }
  window.__dailyChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [
      { label: 'VPN', data: vpn },
      { label: 'Honeyfield', data: honeyfield },
      { label: 'Honeypot', data: honeypot },
      { label: 'Behavior', data: behavior },
    ]},
    options: {
      responsive: true, maintainAspectRatio: true, aspectRatio: 16/9,
      plugins: { legend: { position: 'bottom' } }
    }
  });
}

async function loadBehaviorTable(per=15){
  const r = await fetch(`/api/events?kind=behavior&page=1&per=${per}`, {cache:'no-store'});
  const data = await r.json();
  const tb = document.getElementById('behaviorBody');
  tb.innerHTML = '';
  for (const row of data.items){
    const tags = (row.details && row.details.tags) ? row.details.tags : [];
    const tr = document.createElement('tr');
    tr.innerHTML =
      `<td class="p-2">${new Date(row.created_at).toLocaleString()}</td>
       <td class="p-2">${row.severity}</td>
       <td class="p-2">${tags.join(', ')}</td>
       <td class="p-2">${row.ip || ''}</td>`;
    tb.appendChild(tr);
  }
}

// Selectable logs controller (VPN/Honeypot/Honeyfield)
async function loadSelectable(kind){
  const r = await fetch(`/api/events?kind=${kind}&page=1&per=15`, {cache:'no-store'});
  const data = await r.json();
  const tb = document.getElementById('selectableBody');
  tb.innerHTML = '';
  for (const row of data.items){
    const details = JSON.stringify(row.details || {}, null, 0).slice(0, 160);
    const tr = document.createElement('tr');
    tr.innerHTML =
      `<td class="p-2">${new Date(row.created_at).toLocaleString()}</td>
       <td class="p-2">${row.severity}</td>
       <td class="p-2">${row.ip || ''}</td>
       <td class="p-2"><pre class="whitespace-pre-wrap text-xs">${details}</pre></td>`;
    tb.appendChild(tr);
  }
}

// Hook dropdown
const kindSelect = document.getElementById('logKind');
if (kindSelect) {
  kindSelect.addEventListener('change', () => loadSelectable(kindSelect.value));
}

// Periodic refresh
function refreshAll(){
  loadMetrics();
  loadBehaviorTable(15);
  const sel = document.getElementById('logKind');
  if (sel) loadSelectable(sel.value);
}
refreshAll();
setInterval(refreshAll, 5000);

// Lightweight behavior telemetry sampler
(function(){
  const tracker = {clicks:0, keys:0, moves:0, path:[], start:performance.now(), last:0};
  window.addEventListener('click', ()=>tracker.clicks++);
  window.addEventListener('keydown', ()=>tracker.keys++);
  window.addEventListener('mousemove', (e)=>{
    tracker.moves++;
    const now = performance.now();
    if(now - tracker.last >= 50){
      tracker.last = now;
      tracker.path.push({x:e.clientX, y:e.clientY, t:Math.round(now)});
      if(tracker.path.length > 300) tracker.path.shift();
    }
  });
  setInterval(async ()=>{
    const payload = {
      clicks: tracker.clicks, keys: tracker.keys, moves: tracker.moves,
      duration_ms: Math.round(performance.now() - tracker.start),
      path: tracker.path.slice()
    };
    tracker.clicks=0; tracker.keys=0; tracker.moves=0; tracker.path=[]; tracker.start=performance.now();
    try {
      await fetch('/api/behavior', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
    } catch(e){}
  }, 3000);
})();
</script>
{% endblock %}
